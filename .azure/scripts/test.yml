# This task tests individual platforms and versions

parameters:
 - name: PIP_CACHE_DIR
   type: string
   default: $(PIP_CACHE_DIR)

steps:

- template: python.yml
  parameters:
    version: '$(python.version)'

- template: jdk.yml
  parameters:
    version: '$(jdk.version)'

- script: |
    pip install . -v
    cd ..
    python -c "import jpype"
  displayName: 'Build/install/check module '


  # Install an editable wheel (re-mapped imports) to the src dir for sake of easy testing.
#- script: |
#    pip install -v -e .
#    dir
#    python -c "import jpype"
#  displayName: 'Build/install/check module (editable)'

- script: |
    pip install -r test-requirements.txt
  displayName: 'Install test requirements'

- script: |
    ant -f test
  displayName: 'Build java tests'

# cd to test first, so avoid to import jpype from the project working dir.
- script: |
    cd test
    python -m pytest -v --junit-xml=test.xml jpypetest --checkjni
  displayName: 'Test JDK $(jdk.version) and Python $(python.version)'
  condition: eq(variables['jpypetest.fast'], 'false')

- script: |
    cd test
    python -m pytest -v --junit-xml=test.xml jpypetest --checkjni --fast
  displayName: 'Test JDK $(jdk.version) and Python $(python.version) (fast)'
  condition: eq(variables['jpypetest.fast'], 'true')

# presence of jpype/ seems to confuse entry_points so `cd` elsewhere
- script: |
    pip install .
    mkdir empty
    cd empty
    python -m PyInstaller.utils.run_tests --include_only jpype._pyinstaller.
  displayName: 'Test PyInstaller result'

- task: PublishTestResults@2
  condition: succeededOrFailed()
  inputs:
     testResultsFiles: 'test/test.xml'
     testRunTitle: 'Publish test results for Python $(python.version) with JDK $(jdk.version)'
