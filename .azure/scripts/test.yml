# This task tests individual platforms and versions
parameters:
  - name: pytest_suppl_args
    type: string
    default: ""
  - name: java_runtime
    type: string
    # to be expanded later in the template compilation via the runtime variable.
    default: "$(jdk.version)"

steps:

- template: python.yml
  parameters:
    version: '$(python.version)'

- template: jdk.yml
  parameters:
    version: '$(jdk.version)'

- template: sdist.yml

- script: |
    python -m pip install -e .
  displayName: 'Build/install module'

- script: |
    pip install numpy jedi typing_extensions
    python -c "import jpype"
  displayName: 'Check module'

- script: |
    pip install setuptools
    python setup.py test_java
    pip install -r test-requirements.txt
  displayName: 'Install test'

- pwsh: |
    python -m pytest -v --junit-xml=build/test/test.xml test/jpypetest --checkjni $env:EXTRA_ARGS
  displayName: "Test JDK $(jdk.version) and Python $(python.version)"
  condition: eq( variables['Agent.OS'], 'Windows_NT' )
  env:
    EXTRA_ARGS: ${{ parameters.pytest_suppl_args }}

- bash: |
    python -m pytest -v --junit-xml=build/test/test.xml test/jpypetest --checkjni $EXTRA_ARGS
  displayName: "Test JDK $(jdk.version) and Python $(python.version)"
  condition: or(eq( variables['Agent.OS'], 'Linux'), eq( variables['Agent.OS'], 'Darwin'))
  env:
    EXTRA_ARGS: ${{ parameters.pytest_suppl_args }}

- script: |
    python -m pytest -v --junit-xml=build/test/test.xml test/jpypetest --checkjni ${{ parameters.pytest_suppl_args }}
  displayName: "jooo"
# presence of jpype/ seems to confuse entry_points so `cd` elsewhere
- script: |
    pip install .
    mkdir empty
    cd empty
    python -m PyInstaller.utils.run_tests --include_only jpype._pyinstaller.
  displayName: 'Test PyInstaller result'

- task: PublishTestResults@2
  condition: succeededOrFailed()
  inputs:
     testResultsFiles: 'build/test/test.xml'
     testRunTitle: 'Publish test results for Python $(python.version) with JDK $(jdk.version)'
