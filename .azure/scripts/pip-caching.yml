steps:
  # Capture the full resolved dependency list
  - script: |
      python -m pip freeze | sort > resolved.txt
    displayName: 'Capture resolved dependencies (Linux/macOS)'
    condition: ne( variables['Agent.OS'], 'Windows_NT' )

  - powershell: |
      python -m pip freeze | Sort-Object | Set-Content resolved.txt
    displayName: 'Capture resolved dependencies (Windows)'
    condition: eq( variables['Agent.OS'], 'Windows_NT' )

  # Compute a checksum for the file
  - bash: |
      echo "##vso[task.setvariable variable=RESOLVED_HASH]$(sha256sum resolved.txt | cut -d' ' -f1)"
    displayName: 'Compute hash of dependencies (Linux/macOS)'
    condition: ne( variables['Agent.OS'], 'Windows_NT' )

  - powershell: |
      $h = (Get-FileHash resolved.txt -Algorithm SHA256).Hash.ToLower()
      Write-Host "##vso[task.setvariable variable=RESOLVED_HASH]$h"
    displayName: 'Compute hash of dependencies (Windows)'
    condition: eq( variables['Agent.OS'], 'Windows_NT' )

  # Restore or populate the cache
  - task: Cache@2
    inputs:
      key: 'python | "$(Agent.OS)" | $(RESOLVED_HASH)'
      path: $(PIP_CACHE_DIR)
